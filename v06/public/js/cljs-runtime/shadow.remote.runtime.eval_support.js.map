{"version":3,"sources":["shadow/remote/runtime/eval_support.cljs"],"mappings":"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","names":["shadow.remote.runtime.eval-support/obj-support-inst","shadow.remote.runtime.eval-support/get-ref","oid","cljs.core.ex_info","shadow.remote.runtime.obj-support/get-ref","p__34980","p__34981","map__34982","cljs.core/PROTOCOL_SENTINEL","cljs.core.apply","cljs.core/hash-map","cljs.core.get","map__34983","shadow.remote.runtime.eval-support/cljs-eval","runtime","obj-support","svc","input","msg","shadow.remote.runtime.api/cljs-eval","p__34989","map__34990","result","info","G__34996","cljs.core/Keyword","map__34997","ex-rid","ex-oid","report","shadow.remote.runtime.shared/reply","map__34999","ex","shadow.remote.runtime.obj-support/register","map__35006","warnings","map__35009","results","time-start","time-finish","val","cljs.core._EQ_","cljs.core/count","cljs.core/first","ref-oid","js/console.error","p__35018","p__35019","map__35020","map__35021","shadow.remote.runtime.eval-support/js-eval","code","e35031","res","shadow.remote.runtime.api/js-eval","e","shadow.remote.runtime.eval-support/start","p1__35038#","p1__35039#","shadow.remote.runtime.shared/add-extension","p__35043","map__35044","shadow.remote.runtime.eval-support/stop","shadow.remote.runtime.api/del-extension"],"sourcesContent":["(ns shadow.remote.runtime.eval-support\n  (:require\n    [shadow.remote.runtime.api :as p]\n    [shadow.remote.runtime.shared :as shared]\n    [shadow.remote.runtime.obj-support :as obj-support]\n    ))\n\n(def ^:dynamic obj-support-inst nil)\n\n(defn get-ref [oid]\n  (when-not obj-support-inst\n    (throw (ex-info \"obj-support not bound, can only call this from eval\" {:oid oid})))\n  (obj-support/get-ref obj-support-inst oid))\n\n(defn cljs-eval\n  [{:keys [^Runtime runtime obj-support] :as svc} {:keys [input] :as msg}]\n  ;; can't use binding because this has to go async\n  ;; required for $o in the UI to work, would be good to have a cleaner API for this\n  (set! obj-support-inst obj-support)\n  (p/cljs-eval runtime input\n    ;; {:code \"1 2 3\"} would trigger 3 results\n    (fn [{:keys [result] :as info}]\n      (set! obj-support-inst nil) ;; cleanup\n\n      ;; (js/console.log \"cljs-eval\" info msg)\n\n      (case result\n        :compile-error\n        (let [{:keys [ex-rid ex-oid report]} info]\n          (shared/reply runtime msg\n            {:op :eval-compile-error\n             :ex-rid ex-rid\n             :ex-oid ex-oid\n             :report report}))\n\n        :runtime-error\n        (let [{:keys [ex]} info\n              ex-oid (obj-support/register obj-support ex {:msg input})]\n          (shared/reply runtime msg\n            {:op :eval-runtime-error\n             :ex-oid ex-oid}))\n\n        :warnings\n        (let [{:keys [warnings]} info]\n          (shared/reply runtime msg\n            {:op :eval-compile-warnings\n             :warnings warnings}))\n\n        :ok\n        (let [{:keys [results warnings time-start time-finish]} info\n              val\n              (if (= 1 (count results))\n                (first results)\n                results)]\n          ;; pretending to be one result always\n          ;; don't want to send multiple results in case code contained multiple forms\n          (let [ref-oid (obj-support/register obj-support val {:msg input})]\n            (shared/reply runtime msg\n              {:op :eval-result-ref\n               :ref-oid ref-oid\n               :eval-ms (- time-finish time-start)\n               :eval-ns (:ns info)\n               :warnings warnings})))\n\n        (js/console.error \"Unhandled cljs-eval result\" info)))))\n\n(defn js-eval\n  [{:keys [^Runtime runtime obj-support] :as svc} {:keys [code] :as msg}]\n\n  (try\n    (let [res (p/js-eval runtime code)\n          ref-oid (obj-support/register obj-support res {:js-code code})]\n\n      (shared/reply runtime msg\n        ;; FIXME: separate result ops for :cljs-eval :js-eval :clj-eval?\n        {:op :eval-result-ref\n         :ref-oid ref-oid}))\n\n    (catch :default e\n      (shared/reply runtime msg\n        {:op :eval-error\n         :e (.-message e)}))))\n\n(defn start [runtime obj-support]\n  (let [svc\n        {:runtime runtime\n         :obj-support obj-support}]\n\n    (shared/add-extension runtime\n      ::ext\n      {:ops\n       {:js-eval #(js-eval svc %)\n        :cljs-eval #(cljs-eval svc %)}})\n\n    svc))\n\n(defn stop [{:keys [runtime] :as svc}]\n  (p/del-extension runtime ::ext))"]}