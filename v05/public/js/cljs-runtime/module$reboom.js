var $jscomp=$jscomp||{};$jscomp.scope={};$jscomp.createTemplateTagFirstArg=function(arrayStrings){return arrayStrings.raw=arrayStrings};$jscomp.createTemplateTagFirstArgWithRaw=function(arrayStrings,rawArrayStrings){arrayStrings.raw=rawArrayStrings;return arrayStrings};$jscomp.arrayIteratorImpl=function(array){var index=0;return function(){return index<array.length?{done:!1,value:array[index++]}:{done:!0}}};$jscomp.arrayIterator=function(array){return{next:$jscomp.arrayIteratorImpl(array)}};
$jscomp.makeIterator=function(iterable){var iteratorFunction="undefined"!=typeof Symbol&&Symbol.iterator&&iterable[Symbol.iterator];return iteratorFunction?iteratorFunction.call(iterable):$jscomp.arrayIterator(iterable)};$jscomp.arrayFromIterator=function(iterator){for(var i,arr=[];!(i=iterator.next()).done;)arr.push(i.value);return arr};$jscomp.arrayFromIterable=function(iterable){return iterable instanceof Array?iterable:$jscomp.arrayFromIterator($jscomp.makeIterator(iterable))};
shadow$provide.module$reboom=function(global,require,module,exports){function deg2rad(deg){return deg*Math.PI/180}function rad2deg(rad){return 180*rad/Math.PI}function clamp(val,min,max){return min>max?clamp(val,max,min):Math.min(Math.max(val,min),max)}function lerp(a,b,t){return a+(b-a)*t}function map(v,l1,h1,l2,h2){return l2+(v-l1)/(h1-l1)*(h2-l2)}function mapc(v,l1,h1,l2,h2){return clamp(map(v,l1,h1,l2,h2),l2,h2)}function vec2(args){for(var $jscomp$restParams=[],$jscomp$restIndex=0;$jscomp$restIndex<
arguments.length;++$jscomp$restIndex)$jscomp$restParams[$jscomp$restIndex-0]=arguments[$jscomp$restIndex];if(0===$jscomp$restParams.length)return vec2(0,0);if(1===$jscomp$restParams.length){if("number"===typeof $jscomp$restParams[0])return vec2($jscomp$restParams[0],$jscomp$restParams[0]);if(isVec2($jscomp$restParams[0]))return vec2($jscomp$restParams[0].x,$jscomp$restParams[0].y);if(Array.isArray($jscomp$restParams[0])&&2===$jscomp$restParams[0].length)return vec2.apply(null,$jscomp$restParams[0])}return{x:$jscomp$restParams[0],
y:$jscomp$restParams[1],clone:function(){return vec2(this.x,this.y)},add:function(args){for(var $jscomp$restParams=[],$jscomp$restIndex=0;$jscomp$restIndex<arguments.length;++$jscomp$restIndex)$jscomp$restParams[$jscomp$restIndex-0]=arguments[$jscomp$restIndex];$jscomp$restParams=vec2.apply(null,$jscomp.arrayFromIterable($jscomp$restParams));return vec2(this.x+$jscomp$restParams.x,this.y+$jscomp$restParams.y)},sub:function(args){for(var $jscomp$restParams=[],$jscomp$restIndex=0;$jscomp$restIndex<
arguments.length;++$jscomp$restIndex)$jscomp$restParams[$jscomp$restIndex-0]=arguments[$jscomp$restIndex];$jscomp$restParams=vec2.apply(null,$jscomp.arrayFromIterable($jscomp$restParams));return vec2(this.x-$jscomp$restParams.x,this.y-$jscomp$restParams.y)},scale:function(args){for(var $jscomp$restParams=[],$jscomp$restIndex=0;$jscomp$restIndex<arguments.length;++$jscomp$restIndex)$jscomp$restParams[$jscomp$restIndex-0]=arguments[$jscomp$restIndex];$jscomp$restParams=vec2.apply(null,$jscomp.arrayFromIterable($jscomp$restParams));
return vec2(this.x*$jscomp$restParams.x,this.y*$jscomp$restParams.y)},dist:function(args){for(var $jscomp$restParams=[],$jscomp$restIndex=0;$jscomp$restIndex<arguments.length;++$jscomp$restIndex)$jscomp$restParams[$jscomp$restIndex-0]=arguments[$jscomp$restIndex];$jscomp$restParams=vec2.apply(null,$jscomp.arrayFromIterable($jscomp$restParams));return Math.sqrt((this.x-$jscomp$restParams.x)*(this.x-$jscomp$restParams.x)+(this.y-$jscomp$restParams.y)*(this.y-$jscomp$restParams.y))},len:function(){return this.dist(vec2(0,
0))},unit:function(){return this.scale(1/this.len())},normal:function(){return vec2(this.y,-this.x)},dot:function(p2){return this.x*p2.x+this.y+p2.y},angle:function(args){for(var $jscomp$restParams=[],$jscomp$restIndex=0;$jscomp$restIndex<arguments.length;++$jscomp$restIndex)$jscomp$restParams[$jscomp$restIndex-0]=arguments[$jscomp$restIndex];$jscomp$restParams=vec2.apply(null,$jscomp.arrayFromIterable($jscomp$restParams));return Math.atan2(this.y-$jscomp$restParams.y,this.x-$jscomp$restParams.x)},
lerp:function(p2,t){return vec2(lerp(this.x,p2.x,t),lerp(this.y,p2.y,t))},toFixed:function(n){return vec2(this.x.toFixed(n),this.y.toFixed(n))},eq:function(other){return this.x===other.x&&this.y===other.y},str:function(){return"("+this.x+", "+this.y+")"}}}function vec2FromAngle(a){return vec2(Math.cos(a),Math.sin(a))}function vec3(x,y,z){return{x:x,y:y,z:z,xy:function(){return vec2(this.x,this.y)}}}function isVec2(p){return void 0!==p&&void 0!==p.x&&void 0!==p.y}function isColor(c){return void 0!==
c&&void 0!==c.r&&void 0!==c.g&&void 0!==c.b&&void 0!==c.a}function rgb(args){for(var $jscomp$restParams=[],$jscomp$restIndex=0;$jscomp$restIndex<arguments.length;++$jscomp$restIndex)$jscomp$restParams[$jscomp$restIndex-0]=arguments[$jscomp$restIndex];if(0===$jscomp$restParams.length)return rgba();if(1===$jscomp$restParams.length){if(isColor($jscomp$restParams[0]))return rgba($jscomp$restParams[0]);if(Array.isArray($jscomp$restParams[0])&&3===$jscomp$restParams[0].length)return rgb.apply(null,$jscomp$restParams[0])}return rgba($jscomp$restParams[0],
$jscomp$restParams[1],$jscomp$restParams[2],1)}function rgba(args){for(var $jscomp$restParams=[],$jscomp$restIndex=0;$jscomp$restIndex<arguments.length;++$jscomp$restIndex)$jscomp$restParams[$jscomp$restIndex-0]=arguments[$jscomp$restIndex];if(0===$jscomp$restParams.length)return rgba(1,1,1,1);if(1===$jscomp$restParams.length){if(isColor($jscomp$restParams[0]))return rgba($jscomp$restParams[0].r,$jscomp$restParams[0].g,$jscomp$restParams[0].b,$jscomp$restParams[0].a);if(Array.isArray($jscomp$restParams[0])&&
4===$jscomp$restParams[0].length)return rgba.apply(null,$jscomp$restParams[0])}return{r:$jscomp$restParams[0],g:$jscomp$restParams[1],b:$jscomp$restParams[2],a:$jscomp$restParams[3]||1,clone:function(){return rgba(this.r,this.g,this.b,this.a)},lighten:function(a){return rgba(this.r+a,this.g+a,this.b+a,this.a)},darken:function(a){return this.lighten(-a)},invert:function(){return rgba(1-this.r,1-this.g,1-this.b,this.a)},isDark:function(p){return this.r+this.g+this.b<3*(void 0===p?.5:p)},isLight:function(p){return this.r+
this.g+this.b>3*(void 0===p?.5:p)},eq:function(other){return this.r===other.r&&this.g===other.g&&this.b===other.g&&this.a===other.a}}}function quad(x,y,w,h){return{x:x,y:y,w:w,h:h,clone:function(){return quad(this.x,this.y,this.w,this.h)},eq:function(other){return this.x===other.x&&this.y===other.y&&this.w===other.w&&this.h===other.h}}}function mat4(m){return{m:m?[].concat($jscomp.arrayFromIterable(m)):[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1],clone:function(){return mat4(this.m)},mult:function(other){for(var out=
[],i=0;4>i;i++)for(var j=0;4>j;j++)out[4*i+j]=this.m[0+j]*other.m[4*i]+this.m[4+j]*other.m[4*i+1]+this.m[8+j]*other.m[4*i+2]+this.m[12+j]*other.m[4*i+3];return mat4(out)},multVec4:function(p){return{x:p.x*this.m[0]+p.y*this.m[4]+p.z*this.m[8]+p.w*this.m[12],y:p.x*this.m[1]+p.y*this.m[5]+p.z*this.m[9]+p.w*this.m[13],z:p.x*this.m[2]+p.y*this.m[6]+p.z*this.m[10]+p.w*this.m[14],w:p.x*this.m[3]+p.y*this.m[7]+p.z*this.m[11]+p.w*this.m[15]}},multVec3:function(p){p=this.multVec4({x:p.x,y:p.y,z:p.z,w:1});
return vec3(p.x,p.y,p.z)},multVec2:function(p){return vec2(p.x*this.m[0]+p.y*this.m[4]+0*this.m[8]+1*this.m[12],p.x*this.m[1]+p.y*this.m[5]+0*this.m[9]+1*this.m[13])},translate:function(p){return this.mult(mat4([1,0,0,0,0,1,0,0,0,0,1,0,p.x,p.y,0,1]))},scale:function(s){return this.mult(mat4([s.x,0,0,0,0,s.y,0,0,0,0,1,0,0,0,0,1]))},rotateX:function(a){return this.mult(mat4([1,0,0,0,0,Math.cos(a),-Math.sin(a),0,0,Math.sin(a),Math.cos(a),0,0,0,0,1]))},rotateY:function(a){return this.mult(mat4([Math.cos(a),
0,-Math.sin(a),0,0,1,0,0,Math.sin(a),0,Math.cos(a),0,0,0,0,1]))},rotateZ:function(a){return this.mult(mat4([Math.cos(a),-Math.sin(a),0,0,Math.sin(a),Math.cos(a),0,0,0,0,1,0,0,0,0,1]))},invert:function(){var out=[],f00=this.m[10]*this.m[15]-this.m[14]*this.m[11],f01=this.m[9]*this.m[15]-this.m[13]*this.m[11],f02=this.m[9]*this.m[14]-this.m[13]*this.m[10],f03=this.m[8]*this.m[15]-this.m[12]*this.m[11],f04=this.m[8]*this.m[14]-this.m[12]*this.m[10],f05=this.m[8]*this.m[13]-this.m[12]*this.m[9],f06=this.m[6]*
this.m[15]-this.m[14]*this.m[7],f07=this.m[5]*this.m[15]-this.m[13]*this.m[7],f08=this.m[5]*this.m[14]-this.m[13]*this.m[6],f09=this.m[4]*this.m[15]-this.m[12]*this.m[7],f10=this.m[4]*this.m[14]-this.m[12]*this.m[6],f11=this.m[5]*this.m[15]-this.m[13]*this.m[7],f12=this.m[4]*this.m[13]-this.m[12]*this.m[5],f13=this.m[6]*this.m[11]-this.m[10]*this.m[7],f14=this.m[5]*this.m[11]-this.m[9]*this.m[7],f15=this.m[5]*this.m[10]-this.m[9]*this.m[6],f16=this.m[4]*this.m[11]-this.m[8]*this.m[7],f17=this.m[4]*
this.m[10]-this.m[8]*this.m[6],f18=this.m[4]*this.m[9]-this.m[8]*this.m[5];out[0]=this.m[5]*f00-this.m[6]*f01+this.m[7]*f02;out[4]=-(this.m[4]*f00-this.m[6]*f03+this.m[7]*f04);out[8]=this.m[4]*f01-this.m[5]*f03+this.m[7]*f05;out[12]=-(this.m[4]*f02-this.m[5]*f04+this.m[6]*f05);out[1]=-(this.m[1]*f00-this.m[2]*f01+this.m[3]*f02);out[5]=this.m[0]*f00-this.m[2]*f03+this.m[3]*f04;out[9]=-(this.m[0]*f01-this.m[1]*f03+this.m[3]*f05);out[13]=this.m[0]*f02-this.m[1]*f04+this.m[2]*f05;out[2]=this.m[1]*f06-
this.m[2]*f07+this.m[3]*f08;out[6]=-(this.m[0]*f06-this.m[2]*f09+this.m[3]*f10);out[10]=this.m[0]*f11-this.m[1]*f09+this.m[3]*f12;out[14]=-(this.m[0]*f08-this.m[1]*f10+this.m[2]*f12);out[3]=-(this.m[1]*f13-this.m[2]*f14+this.m[3]*f15);out[7]=this.m[0]*f13-this.m[2]*f16+this.m[3]*f17;out[11]=-(this.m[0]*f14-this.m[1]*f16+this.m[3]*f18);out[15]=this.m[0]*f15-this.m[1]*f17+this.m[2]*f18;f00=this.m[0]*out[0]+this.m[1]*out[4]+this.m[2]*out[8]+this.m[3]*out[12];for(f01=0;4>f01;f01++)for(f02=0;4>f02;f02++)out[4*
f01+f02]*=1/f00;return mat4(out)}}}function wave(lo,hi,t){return lo+(Math.sin(t)+1)/2*(hi-lo)}function makeRng(seed){return{seed:seed,gen:function(args){for(var $jscomp$restParams=[],$jscomp$restIndex=0;$jscomp$restIndex<arguments.length;++$jscomp$restIndex)$jscomp$restParams[$jscomp$restIndex-0]=arguments[$jscomp$restIndex];if(0===$jscomp$restParams.length)return this.seed=(1103515245*this.seed+12345)%2147483648,this.seed/2147483648;if(1===$jscomp$restParams.length){if("number"===typeof $jscomp$restParams[0])return this.gen(0,
$jscomp$restParams[0]);if(isVec2($jscomp$restParams[0]))return this.gen(vec2(0,0),$jscomp$restParams[0]);if(isColor($jscomp$restParams[0]))return this.gen(rgba(0,0,0,0),$jscomp$restParams[0])}else if(2===$jscomp$restParams.length){if(" \x26\x26 typeof args[1] \x3d\x3d\x3d"===typeof $jscomp$restParams[0])return this.gen()*($jscomp$restParams[1]-$jscomp$restParams[0])+$jscomp$restParams[0];if(isVec2($jscomp$restParams[0])&&isVec2($jscomp$restParams[1]))return vec2(this.gen($jscomp$restParams[0].x,$jscomp$restParams[1].x),
this.gen($jscomp$restParams[0].y,$jscomp$restParams[1].y));if(isColor($jscomp$restParams[0])&&isColor($jscomp$restParams[1]))return rgba(this.gen($jscomp$restParams[0].r,$jscomp$restParams[1].r),this.gen($jscomp$restParams[0].g,$jscomp$restParams[1].g),this.gen($jscomp$restParams[0].b,$jscomp$restParams[1].b),this.gen($jscomp$restParams[0].a,$jscomp$restParams[1].a))}}}}function randSeed(seed){null!=seed&&(defRNG.seed=seed);return defRNG.seed}function rand(args){for(var $jscomp$restParams=[],$jscomp$restIndex=
0;$jscomp$restIndex<arguments.length;++$jscomp$restIndex)$jscomp$restParams[$jscomp$restIndex-0]=arguments[$jscomp$restIndex];return defRNG.gen.apply(defRNG,$jscomp.arrayFromIterable($jscomp$restParams))}function chance(p){return rand()<=p}function choose(list){return list[Math.floor(rand(list.length))]}function colRectRect(r1,r2){return r1.p2.x>=r2.p1.x&&r1.p1.x<=r2.p2.x&&r1.p2.y>=r2.p1.y&&r1.p1.y<=r2.p2.y}function deepEq(o1,o2){var t1=typeof o1,t2=typeof o2;if(t1!==t2)return!1;if("object"===t1&&
"object"===t2){t1=Object.keys(o1);t2=Object.keys(o2);if(t1.length!==t2.length)return!1;t1=$jscomp.makeIterator(t1);for(t2=t1.next();!t2.done;t2=t1.next()){var k=t2.value;t2=o1[k];k=o2[k];if(("function"!==typeof t2||"function"!==typeof k)&&!deepEq(t2,k))return!1}return!0}return o1===o2}function originPt(orig){switch(orig){case "topleft":return vec2(-1,-1);case "top":return vec2(0,-1);case "topright":return vec2(1,-1);case "left":return vec2(-1,0);case "center":return vec2(0,0);case "right":return vec2(1,
0);case "botleft":return vec2(-1,1);case "bot":return vec2(0,1);case "botright":return vec2(1,1);default:return orig}}function gfxInit(gl,gconf){function makeTex(data){var id=gl.createTexture();gl.bindTexture(gl.TEXTURE_2D,id);gl.texImage2D(gl.TEXTURE_2D,0,gl.RGBA,gl.RGBA,gl.UNSIGNED_BYTE,data);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MIN_FILTER,texFilter);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MAG_FILTER,texFilter);var JSCompiler_inline_result=0===Math.log(data.width)/Math.log(2)%1&&0===Math.log(data.height)/
Math.log(2)%1?gl.REPEAT:gl.CLAMP_TO_EDGE;gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_S,JSCompiler_inline_result);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_T,JSCompiler_inline_result);gl.bindTexture(gl.TEXTURE_2D,null);return{width:data.width,height:data.height,bind:function(){gl.bindTexture(gl.TEXTURE_2D,id)},unbind:function(){gl.bindTexture(gl.TEXTURE_2D,null)}}}function makeProgram(vertSrc,fragSrc){fragSrc=void 0===fragSrc?"\nvec4 frag(vec3 pos, vec2 uv, vec4 color, sampler2D tex) {\n\treturn def_frag();\n}\n":
fragSrc;vertSrc="\nattribute vec3 a_pos;\nattribute vec2 a_uv;\nattribute vec4 a_color;\n\nvarying vec3 v_pos;\nvarying vec2 v_uv;\nvarying vec4 v_color;\n\nvec4 def_vert() {\n\treturn vec4(a_pos, 1.0);\n}\n\n{{user}}\n\nvoid main() {\n\tvec4 pos \x3d vert(a_pos, a_uv, a_color);\n\tv_pos \x3d a_pos;\n\tv_uv \x3d a_uv;\n\tv_color \x3d a_color;\n\tgl_Position \x3d pos;\n}\n".replace("{{user}}",(void 0===vertSrc?"\nvec4 vert(vec3 pos, vec2 uv, vec4 color) {\n\treturn def_vert();\n}\n":vertSrc)||"\nvec4 vert(vec3 pos, vec2 uv, vec4 color) {\n\treturn def_vert();\n}\n");
var fcode="\nprecision mediump float;\n\nvarying vec3 v_pos;\nvarying vec2 v_uv;\nvarying vec4 v_color;\n\nuniform sampler2D u_tex;\n\nvec4 def_frag() {\n\treturn v_color * texture2D(u_tex, v_uv);\n}\n\n{{user}}\n\nvoid main() {\n\tgl_FragColor \x3d frag(v_pos, v_uv, v_color, u_tex);\n\tif (gl_FragColor.a \x3d\x3d 0.0) {\n\t\tdiscard;\n\t}\n}\n".replace("{{user}}",fragSrc||"\nvec4 frag(vec3 pos, vec2 uv, vec4 color, sampler2D tex) {\n\treturn def_frag();\n}\n");fragSrc=gl.createShader(gl.VERTEX_SHADER);
var fragShader=gl.createShader(gl.FRAGMENT_SHADER);gl.shaderSource(fragSrc,vertSrc);gl.shaderSource(fragShader,fcode);gl.compileShader(fragSrc);gl.compileShader(fragShader);if(vertSrc=gl.getShaderInfoLog(fragSrc))throw Error(vertSrc);if(vertSrc=gl.getShaderInfoLog(fragShader))throw Error(vertSrc);var id=gl.createProgram();gl.attachShader(id,fragSrc);gl.attachShader(id,fragShader);gl.bindAttribLocation(id,0,"a_pos");gl.bindAttribLocation(id,1,"a_uv");gl.bindAttribLocation(id,2,"a_color");gl.linkProgram(id);
if((vertSrc=gl.getProgramInfoLog(id))&&"\n"!==vertSrc)throw Error(vertSrc);return{bind:function(){gl.useProgram(id)},unbind:function(){gl.useProgram(null)},bindAttribs:function(){gl.vertexAttribPointer(0,3,gl.FLOAT,!1,36,0);gl.enableVertexAttribArray(0);gl.vertexAttribPointer(1,2,gl.FLOAT,!1,36,12);gl.enableVertexAttribArray(1);gl.vertexAttribPointer(2,4,gl.FLOAT,!1,36,20);gl.enableVertexAttribArray(2)},send:function(uniform){this.bind();for(var name in uniform){var val=uniform[name],loc=gl.getUniformLocation(id,
name);if("number"===typeof val)gl.uniform1f(loc,val);else{var JSCompiler_inline_result=void 0!==val&&Array.isArray(val.m)&&16===val.m.length?val:void 0;JSCompiler_inline_result?gl.uniformMatrix4fv(loc,!1,new Float32Array(val.m)):isColor(val)?gl.uniform4f(loc,val.r,val.g,val.b,val.a):void 0!==val&&void 0!==val.x&&void 0!==val.y&&void 0!==val.z?gl.uniform3f(loc,val.x,val.y,val.z):isVec2(val)&&gl.uniform2f(loc,val.x,val.y)}}this.unbind()}}}function drawRaw(verts,indices,tex,prog,uniform){tex=void 0===
tex?gfx.defTex:tex;prog=void 0===prog?gfx.defProg:prog;uniform=void 0===uniform?{}:uniform;tex=tex?tex:gfx.defTex;prog=prog?prog:gfx.defProg;(tex!==gfx.curTex||prog!==gfx.curProg||!deepEq(gfx.curUniform,uniform)||65536<gfx.vqueue.length+9*verts.length||65536<gfx.iqueue.length+indices.length)&&flush();gfx.curTex=tex;gfx.curProg=prog;gfx.curUniform=uniform;indices=indices.map(function(i){return i+gfx.vqueue.length/9});verts=verts.map(function(v){var JSCompiler_inline_result=gfx.transform.multVec2(v.pos.xy());
JSCompiler_inline_result=vec2(JSCompiler_inline_result.x/width()*2-1,-JSCompiler_inline_result.y/height()*2+1);return[JSCompiler_inline_result.x,JSCompiler_inline_result.y,v.pos.z,v.uv.x,v.uv.y,v.color.r,v.color.g,v.color.b,v.color.a]}).flat();indices.forEach(function(i){return gfx.iqueue.push(i)});verts.forEach(function(v){return gfx.vqueue.push(v)})}function flush(){gfx.curTex&&gfx.curProg&&0!==gfx.vqueue.length&&0!==gfx.iqueue.length&&(gfx.curProg.send(gfx.curUniform),gl.bindBuffer(gl.ARRAY_BUFFER,
gfx.vbuf),gl.bufferSubData(gl.ARRAY_BUFFER,0,new Float32Array(gfx.vqueue)),gl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER,gfx.ibuf),gl.bufferSubData(gl.ELEMENT_ARRAY_BUFFER,0,new Uint16Array(gfx.iqueue)),gfx.curProg.bind(),gfx.curProg.bindAttribs(),gfx.curTex.bind(),gl.drawElements(gl.TRIANGLES,gfx.iqueue.length,gl.UNSIGNED_SHORT,0),gfx.curTex.unbind(),gfx.curProg.unbind(),gl.bindBuffer(gl.ARRAY_BUFFER,null),gl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER,null),gfx.iqueue=[],gfx.vqueue=[],gfx.drawCalls++)}function frameStart(){gl.clear(gl.COLOR_BUFFER_BIT);
gconf.clearColor||drawQuad({width:width(),height:height(),quad:quad(0,0,width()*scale$jscomp$0()/64,height()*scale$jscomp$0()/64),tex:gfx.bgTex});gfx.drawCalls=0;gfx.transformStack=[];gfx.transform=mat4()}function frameEnd(){flush();gfx.lastDrawCalls=gfx.drawCalls}function pushTranslate(p){!p||0===p.x&&0===p.y||(gfx.transform=gfx.transform.translate(p))}function pushTransform(){gfx.transformStack.push(gfx.transform.clone())}function popTransform(){0<gfx.transformStack.length&&(gfx.transform=gfx.transformStack.pop())}
function drawQuad(conf){conf=void 0===conf?{}:conf;var w=conf.width||0,h=conf.height||0,pos=conf.pos||vec2(0,0),offset=originPt(conf.origin||"topleft").scale(vec2(w,h).scale(-.5)),scale=vec2(conf.scale||1),rot=conf.rot||0,q=conf.quad||quad(0,0,1,1),z=1-(conf.z||0),color=conf.color||rgba(1,1,1,1);pushTransform();pushTranslate(pos);!scale||1===scale.x&&1===scale.y||(gfx.transform=gfx.transform.scale(scale));rot&&(gfx.transform=gfx.transform.rotateZ(rot));pushTranslate(offset);drawRaw([{pos:vec3(-w/
2,h/2,z),uv:vec2(q.x,q.y+q.h),color:color},{pos:vec3(-w/2,-h/2,z),uv:vec2(q.x,q.y),color:color},{pos:vec3(w/2,-h/2,z),uv:vec2(q.x+q.w,q.y),color:color},{pos:vec3(w/2,h/2,z),uv:vec2(q.x+q.w,q.y+q.h),color:color}],[0,1,3,1,2,3],conf.tex,conf.prog,conf.uniform);popTransform()}function drawLine(p1,p2,conf){conf=void 0===conf?{}:conf;var w=conf.width||1,h=p1.dist(p2),rot=Math.PI/2-p1.angle(p2);drawQuad(Object.assign({},conf,{pos:p1.add(p2).scale(.5),width:w,height:h,rot:rot,origin:"center"}))}function fmtText(text,
font,conf){conf=void 0===conf?{}:conf;var chars=(text+"").split("");text=font.qw*font.tex.width;var gh=font.qh*font.tex.height,scale=vec2((conf.size||gh)/gh).scale(vec2(conf.scale||1)),cw=scale.x*text,ch=scale.y*gh;text=0;gh=ch;var tw=0,flines=[[]];chars=$jscomp.makeIterator(chars);for(var $jscomp$key$char=chars.next();!$jscomp$key$char.done;$jscomp$key$char=chars.next()){$jscomp$key$char=$jscomp$key$char.value;if("\n"===$jscomp$key$char||conf.width&&text+cw>conf.width)gh+=ch,text=0,flines.push([]);
"\n"!==$jscomp$key$char&&(flines[flines.length-1].push($jscomp$key$char),text+=cw);tw=Math.max(tw,text)}conf.width&&(tw=conf.width);var fchars=[],pos=vec2(conf.pos||0),offset=originPt(conf.origin||"topleft").scale(.5),ox=-offset.x*cw-(offset.x+.5)*(tw-cw),oy=-offset.y*ch-(offset.y+.5)*(gh-ch);flines.forEach(function(line,ln){var oxl=(tw-line.length*cw)*(offset.x+.5);line.forEach(function(char,cn){var qpos=font.map[char];cn*=cw;var y=ln*ch;qpos&&fchars.push({tex:font.tex,quad:quad(qpos.x,qpos.y,font.qw,
font.qh),ch:char,pos:vec2(pos.x+cn+ox+oxl,pos.y+y+oy),color:conf.color,origin:conf.origin,scale:scale,z:conf.z})})});return{width:tw,height:gh,chars:fchars}}function drawFmtText(ftext){ftext=$jscomp.makeIterator(ftext.chars);for(var $jscomp$key$ch=ftext.next();!$jscomp$key$ch.done;$jscomp$key$ch=ftext.next())$jscomp$key$ch=$jscomp$key$ch.value,drawQuad({tex:$jscomp$key$ch.tex,width:$jscomp$key$ch.tex.width*$jscomp$key$ch.quad.w,height:$jscomp$key$ch.tex.height*$jscomp$key$ch.quad.h,pos:$jscomp$key$ch.pos,
scale:$jscomp$key$ch.scale,color:$jscomp$key$ch.color,quad:$jscomp$key$ch.quad,origin:"center",z:$jscomp$key$ch.z})}function width(){return gl.drawingBufferWidth/scale$jscomp$0()}function height(){return gl.drawingBufferHeight/scale$jscomp$0()}function scale$jscomp$0(){return gconf.scale||1}var texFilter=function(){switch(gconf.texFilter){case "linear":return gl.LINEAR;case "nearest":return gl.NEAREST;default:return gl.NEAREST}}(),gfx=function(){var defProg=makeProgram("\nvec4 vert(vec3 pos, vec2 uv, vec4 color) {\n\treturn def_vert();\n}\n",
"\nvec4 frag(vec3 pos, vec2 uv, vec4 color, sampler2D tex) {\n\treturn def_frag();\n}\n"),emptyTex=makeTex(new ImageData(new Uint8ClampedArray([255,255,255,255]),1,1)),c=gconf.clearColor||rgba(0,0,0,1);gl.clearColor(c.r,c.g,c.b,c.a);gl.enable(gl.BLEND);gl.blendFuncSeparate(gl.SRC_ALPHA,gl.ONE_MINUS_SRC_ALPHA,gl.ONE,gl.ONE_MINUS_SRC_ALPHA);var vbuf=gl.createBuffer();gl.bindBuffer(gl.ARRAY_BUFFER,vbuf);gl.bufferData(gl.ARRAY_BUFFER,262144,gl.DYNAMIC_DRAW);gl.bindBuffer(gl.ARRAY_BUFFER,null);var ibuf=
gl.createBuffer();gl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER,ibuf);gl.bufferData(gl.ELEMENT_ARRAY_BUFFER,131072,gl.DYNAMIC_DRAW);gl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER,null);var bgTex=makeTex(new ImageData(new Uint8ClampedArray([128,128,128,255,190,190,190,255,190,190,190,255,128,128,128,255]),2,2));return{drawCalls:0,lastDrawCalls:0,defProg:defProg,curProg:defProg,defTex:emptyTex,curTex:emptyTex,curUniform:{},vbuf:vbuf,ibuf:ibuf,vqueue:[],iqueue:[],transform:mat4(),transformStack:[],clearColor:c,bgTex:bgTex}}();
frameStart();frameEnd();return{width:width,height:height,scale:scale$jscomp$0,makeTex:makeTex,makeProgram:makeProgram,makeFont:function(tex,gw,gh,chars){gw=tex.width/gw;var qw=1/gw;gh=1/(tex.height/gh);var map={};chars=chars.split("").entries();chars=$jscomp.makeIterator(chars);for(var $jscomp$key$=chars.next();!$jscomp$key$.done;$jscomp$key$=chars.next()){var $jscomp$destructuring$var1=$jscomp.makeIterator($jscomp$key$.value);$jscomp$key$=$jscomp$destructuring$var1.next().value;$jscomp$destructuring$var1=
$jscomp$destructuring$var1.next().value;map[$jscomp$destructuring$var1]=vec2($jscomp$key$%gw*qw,Math.floor($jscomp$key$/gw)*gh)}return{tex:tex,map:map,qw:qw,qh:gh}},drawTexture:function(tex,conf){conf=void 0===conf?{}:conf;var q=conf.quad||quad(0,0,1,1);drawQuad(Object.assign({},conf,{tex:tex,quad:q,width:tex.width*q.w,height:tex.height*q.h}))},drawText:function(txt,font,conf){conf=void 0===conf?{}:conf;drawFmtText(fmtText(txt,font,conf))},drawFmtText:drawFmtText,drawRect:function(pos,w,h,conf){conf=
void 0===conf?{}:conf;drawQuad(Object.assign({},conf,{pos:pos,width:w,height:h}))},drawRectStroke:function(pos,w,h,conf){conf=void 0===conf?{}:conf;var offset=originPt(conf.origin||"topleft").scale(vec2(w,h)).scale(.5),p1=pos.add(vec2(-w/2,-h/2)).sub(offset),p2=pos.add(vec2(-w/2,h/2)).sub(offset),p3=pos.add(vec2(w/2,h/2)).sub(offset);pos=pos.add(vec2(w/2,-h/2)).sub(offset);drawLine(p1,p2,conf);drawLine(p2,p3,conf);drawLine(p3,pos,conf);drawLine(pos,p1,conf)},drawLine:drawLine,fmtText:fmtText,frameStart:frameStart,
frameEnd:frameEnd,pushTransform:pushTransform,popTransform:popTransform,pushMatrix:function(m){gfx.transform=m.clone()},drawCalls:function(){return gfx.lastDrawCalls},clearColor:function(){return gfx.clearColor.clone()}}}function processBtnState(s){return"pressed"===s||"rpressed"===s?"down":"released"===s?"up":s}function appInit(gconf){gconf=void 0===gconf?{}:gconf;var app={canvas:gconf.canvas?gconf.canvas:function(){var canvas=document.createElement("canvas");(gconf.root?gconf.root:document.body).appendChild(canvas);
return canvas}(),loopID:null,stopped:!1,keyStates:{},charInputted:[],mouseState:"up",mousePos:vec2(0,0),skipTime:!1,scale:gconf.scale?gconf.scale:1,realTime:0,dt:0,isTouch:!1,fps:0,time:0,fpsBuf:[],fpsTimer:0};localStorage.setItem("app",JSON.stringify(app));console.log("app",app);var keyMap={ArrowLeft:"left",ArrowRight:"right",ArrowUp:"up",ArrowDown:"down"," ":"space"},preventDefaultKeys="space left right up down tab f1 f2 f3 f4 f5 f6 f7 f8 f9 f10 f11".split(" ");gconf.fullscreen?(app.canvas.width=
window.innerWidth,app.canvas.height=window.innerHeight):(app.canvas.width=(gconf.width||640)*app.scale,app.canvas.height=(gconf.height||480)*app.scale);var styles=["outline: none","cursor: default"];gconf.crisp&&(styles.push("image-rendering: pixelated"),styles.push("image-rendering: crisp-edges"));app.canvas.style=styles.join(";");app.canvas.setAttribute("tabindex","0");styles=app.canvas.getContext("webgl",{antialias:!0,depth:!0,stencil:!0,alpha:!0,preserveDrawingBuffer:!0});app.isTouch="ontouchstart"in
window||0<navigator.maxTouchPoints||0<navigator.msMaxTouchPoints;app.canvas.addEventListener("mousemove",function(e){app.mousePos=vec2(e.offsetX,e.offsetY).scale(1/app.scale)});app.canvas.addEventListener("mousedown",function(){app.mouseState="pressed"});app.canvas.addEventListener("mouseup",function(){app.mouseState="released"});app.canvas.addEventListener("touchstart",function(e){e=e.touches[0];app.mousePos=vec2(e.clientX,e.clientY).scale(1/app.scale);app.mouseState="pressed"});app.canvas.addEventListener("touchmove",
function(e){e=e.touches[0];app.mousePos=vec2(e.clientX,e.clientY).scale(1/app.scale)});app.canvas.addEventListener("keydown",function(e){var k=keyMap[e.key]||e.key.toLowerCase();preventDefaultKeys.includes(k)&&e.preventDefault();1===k.length&&app.charInputted.push(k);"space"===k&&app.charInputted.push(" ");app.keyStates[k]=e.repeat?"rpressed":"pressed"});app.canvas.addEventListener("keyup",function(e){e=keyMap[e.key]||e.key.toLowerCase();app.keyStates[e]="released"});app.canvas.focus();document.addEventListener("visibilitychange",
function(){switch(document.visibilityState){case "visible":app.skipTime=!0}});return{gl:styles,keyDown:function(k){return"pressed"===app.keyStates[k]||"rpressed"===app.keyStates[k]||"down"===app.keyStates[k]},keyPressed:function(k){return"pressed"===app.keyStates[k]},keyPressedRep:function(k){return"pressed"===app.keyStates[k]||"rpressed"===app.keyStates[k]},keyReleased:function(k){return"released"===app.keyStates[k]},mouseDown:function(){return"pressed"===app.mouseState||"down"===app.mouseState},
mouseClicked:function(){return"pressed"===app.mouseState},mouseReleased:function(){return"released"===app.mouseState},charInputted:function(){return[].concat($jscomp.arrayFromIterable(app.charInputted))},mousePos:function(){return app.mousePos.clone()},dt:function(){return app.dt},time:function(){return app.time},fps:function(){return app.fps},screenshot:function(){return app.canvas.toDataURL()},cursor:function(c){c&&(app.canvas.style.cursor=c?c:"default");return app.canvas.style.cursor},focused:function(){return document.activeElement===
app.canvas},focus:function(){app.canvas.focus()},run:function(f){var frame=function(t){t/=1E3;var realDt=t-app.realTime;app.realTime=t;app.skipTime||(app.dt=realDt,app.time+=app.dt,app.fpsBuf.push(1/app.dt),app.fpsTimer+=app.dt,1<=app.fpsTimer&&(app.fpsTimer=0,app.fps=Math.round(app.fpsBuf.reduce(function(a,b){return a+b})/app.fpsBuf.length),app.fpsBuf=[]));app.skipTime=!1;f();for(var k in app.keyStates)app.keyStates[k]=processBtnState(app.keyStates[k]);app.mouseState=processBtnState(app.mouseState);
app.charInputted=[];app.stopped||(app.loopID=requestAnimationFrame(frame))};app.loopID=requestAnimationFrame(frame)},quit:function(){cancelAnimationFrame(app.loopID);app.stopped=!0}}}function audioInit(){var audio=function(){var ctx=new (window.AudioContext||window.webkitAudioContext),gainNode=ctx.createGain();gainNode.connect(ctx.destination);return{ctx:ctx,gainNode:gainNode,masterNode:gainNode}}();return{ctx:function(){return audio.ctx},volume:function(v){void 0!==v&&(audio.gainNode.gain.value=
clamp(v,0,3));return audio.gainNode.gain.value},play:function(sound,conf){conf=void 0===conf?{loop:!1,volume:1,speed:1,detune:0,seek:0}:conf;var stopped=!1,srcNode=audio.ctx.createBufferSource();srcNode.buffer=sound;srcNode.loop=conf.loop?!0:!1;var gainNode=audio.ctx.createGain();srcNode.connect(gainNode);gainNode.connect(audio.masterNode);var pos=conf.seek?conf.seek:0;srcNode.start(0,pos);var startTime=audio.ctx.currentTime-pos,stopTime=null;pos={stop:function(){stopped||(this.pause(),startTime=
audio.ctx.currentTime)},play:function(seek){if(stopped){var oldNode=srcNode;srcNode=audio.ctx.createBufferSource();srcNode.buffer=oldNode.buffer;srcNode.loop=oldNode.loop;srcNode.playbackRate.value=oldNode.playbackRate.value;srcNode.detune&&(srcNode.detune.value=oldNode.detune.value);srcNode.connect(gainNode);seek=seek?seek:this.time();srcNode.start(0,seek);startTime=audio.ctx.currentTime-seek;stopped=!1;stopTime=null}},pause:function(){stopped||(srcNode.stop(),stopped=!0,stopTime=audio.ctx.currentTime)},
paused:function(){return stopped},stopped:function(){return stopped},speed:function(val){void 0!==val&&(srcNode.playbackRate.value=clamp(val,0,3));return srcNode.playbackRate.value},detune:function(val){if(!srcNode.detune)return 0;void 0!==val&&(srcNode.detune.value=clamp(val,-1200,1200));return srcNode.detune.value},volume:function(val){void 0!==val&&(gainNode.gain.value=clamp(val,0,3));return gainNode.gain.value},loop:function(){srcNode.loop=!0},unloop:function(){srcNode.loop=!1},duration:function(){return sound.duration},
time:function(){return stopped?stopTime-startTime:audio.ctx.currentTime-startTime}};pos.speed(conf.speed);pos.detune(conf.detune);pos.volume(conf.volume);return pos}}}function loadImg(src){var img=new Image;img.src=src;img.crossOrigin="anonymous";return new Promise(function(resolve,reject){img.onload=function(){resolve(img)};img.onerror=function(){reject("failed to load "+src)}})}function assetsInit(gfx,audio,gconf){function addLoader(prom){var id=assets.lastLoaderID;assets.loaders[id]=!1;assets.lastLoaderID++;
prom.catch(gconf.errHandler?gconf.errHandler:console.error).finally(function(){assets.loaders[id]=!0})}function loadFont(name,src,gw,gh,chars){chars=void 0===chars?" !\"#$%\x26'()*+,-./0123456789:;\x3c\x3d\x3e?@ABCDEFGHIJKLMNOPQRSTUVWXYZ[\\]^_`abcdefghijklmnopqrstuvwxyz{|}~":chars;var loader=new Promise(function(resolve,reject){var path=src.startsWith("data:")?src:assets.loadRoot+src;loadImg(path).then(function(img){img=gfx.makeFont(gfx.makeTex(img),gw,gh,chars);assets.fonts[name]=img;resolve(img)}).catch(reject)});
addLoader(loader);return loader}var assets={lastLoaderID:0,loadRoot:"",loaders:{},sprites:{},sounds:{},fonts:{},shaders:{}};loadFont("unscii","https://raw.githubusercontent.com/replit/kaboom/master/src/assets/unscii_8x8.png",8,8);return{loadRoot:function(path){path&&(assets.loadRoot=path);return assets.loadRoot},loadSprite:function(name$jscomp$0,src$jscomp$0,conf$jscomp$0){function loadRawSprite(name,src,conf){conf=void 0===conf?{sliceX:1,sliceY:1,gridWidth:0,gridHeight:0,anims:{}}:conf;var frames=
[];src=gfx.makeTex(src);for(var sliceX=conf.sliceX||src.width/(conf.gridWidth||src.width),sliceY=conf.sliceY||src.height/(conf.gridHeight||src.height),qw=1/sliceX,qh=1/sliceY,j=0;j<sliceY;j++)for(var i=0;i<sliceX;i++)frames.push(quad(i*qw,j*qh,qw,qh));conf={tex:src,frames:frames,anims:conf.anims||{}};return assets.sprites[name]=conf}conf$jscomp$0=void 0===conf$jscomp$0?{sliceX:1,sliceY:1,anims:{}}:conf$jscomp$0;var loader=new Promise(function(resolve,reject){if(!src$jscomp$0)return reject('expected sprite src for "'+
name$jscomp$0+'"');if("string"===typeof src$jscomp$0){var path=src$jscomp$0.startsWith("data:")?src$jscomp$0:assets.loadRoot+src$jscomp$0;loadImg(path).then(function(img){resolve(loadRawSprite(name$jscomp$0,img,conf$jscomp$0))}).catch(reject)}else resolve(loadRawSprite(name$jscomp$0,src$jscomp$0,conf$jscomp$0))});addLoader(loader);return loader},loadSound:function(name,src){var url=assets.loadRoot+src,loader=new Promise(function(resolve,reject){if(!src)return reject('expected sound src for "'+name+
'"');"string"===typeof src&&fetch(url).then(function(res){if(res.ok)return res.arrayBuffer();throw Error("failed to load "+url);}).then(function(data){return new Promise(function(resolve2,reject2){audio.ctx().decodeAudioData(data,resolve2,reject2)})}).then(function(buf){assets.sounds[name]=buf;resolve(buf)}).catch(reject)});addLoader(loader);return loader},loadFont:loadFont,loadShader:function(name$jscomp$0,vert,frag,isUrl){function loadRawShader(name,vert,frag){vert=gfx.makeProgram(vert,frag);return assets.shaders[name]=
vert}isUrl=void 0===isUrl?!1:isUrl;var loader=new Promise(function(resolve,reject){function resolveUrl(url){return url?fetch(assets.loadRoot+url).then(function(r){if(r.ok)return r.text();throw Error("failed to load "+url);}).catch(reject):new Promise(function(r){return r(null)})}if(!vert&&!frag)return reject("no shader");if(isUrl)Promise.all([resolveUrl(vert),resolveUrl(frag)]).then(function($jscomp$destructuring$var2){var $jscomp$destructuring$var3=$jscomp.makeIterator($jscomp$destructuring$var2);
$jscomp$destructuring$var2=$jscomp$destructuring$var3.next().value;$jscomp$destructuring$var3=$jscomp$destructuring$var3.next().value;resolve(loadRawShader(name$jscomp$0,$jscomp$destructuring$var2,$jscomp$destructuring$var3))}).catch(reject);else try{resolve(loadRawShader(name$jscomp$0,vert,frag))}catch(err){reject(err)}});addLoader(loader);return loader},loadProgress:function(){var total=0,loaded=0,id;for(id in assets.loaders)total+=1,assets.loaders[id]&&(loaded+=1);return loaded/total},addLoader:addLoader,
defFont:function(){return assets.fonts.unscii},sprites:assets.sprites,fonts:assets.fonts,sounds:assets.sounds,shaders:assets.shaders}}function loggerInit(gfx,assets,conf){conf=void 0===conf?{max:8}:conf;var logs=[],max=conf.max||8;return{info:function(msg){logs.unshift({type:"info",msg:msg})},error:function(msg){console.error(msg);logs.unshift({type:"error",msg:msg})},draw:function(){logs.length>max&&(logs=logs.slice(0,max));var pos=vec2(0,gfx.height());logs.forEach(function(log,i){var txtAlpha=map(i,
0,max,1,.5);i=map(i,0,max,.8,.2);a:{switch(log.type){case "info":txtAlpha=rgba(1,1,1,txtAlpha);break a;case "error":txtAlpha=rgba(1,0,.5,txtAlpha);break a}txtAlpha=void 0}log=gfx.fmtText(log.msg,assets.defFont(),{pos:pos,origin:"botleft",color:txtAlpha,size:16/gfx.scale(),width:gfx.width()});gfx.drawRect(pos,log.width,log.height,{origin:"botleft",color:rgba(0,0,0,i)});gfx.drawFmtText(log);pos.y-=log.height})},clear:function(){logs=[]}}}function netInit(url){var handlers={},sendQueue=[],socket=null;
return{connect:function(){var ws=new WebSocket(url);return new Promise<WebSocket>function(resolve,reject){ws.onopen=function(){resolve(ws);socket=ws;for(var $jscomp$iter$4=$jscomp.makeIterator(sendQueue),$jscomp$key$msg=$jscomp$iter$4.next();!$jscomp$key$msg.done;$jscomp$key$msg=$jscomp$iter$4.next())ws.send($jscomp$key$msg.value)};ws.onerror=function(){reject("failed to connect to "+url)};ws.onmessage=function(e){e=JSON.parse(e.data);if(handlers[e.type])for(var $jscomp$iter$5=$jscomp.makeIterator(handlers[e.type]),
$jscomp$key$handler=$jscomp$iter$5.next();!$jscomp$key$handler.done;$jscomp$key$handler=$jscomp$iter$5.next())$jscomp$key$handler=$jscomp$key$handler.value,$jscomp$key$handler(e.id,e.data)}}},close:function(){socket&&socket.close()},connected:function(){return null!==socket&&1===socket.readyState},recv:function(type,handler){handlers[type]||(handlers[type]=[]);handlers[type].push(handler)},send:function(type,data){type=JSON.stringify({type:type,data:data});socket?socket.send(type):sendQueue.push(type)}}}
var defRNG=makeRng(Date.now());window.reboom=function(gconf){function recv(ty,handler){if(!net)throw Error("not connected to any websockets");net.recv(ty,function(data,id){try{handler(data,id)}catch(err){logger.error(err)}})}function send(ty,data){if(!net)throw Error("not connected to any websockets");net.send(ty,data)}function dt(){return app.dt()*debug.timeScale}function isCamLayer(layer){var scene=curScene();return!(scene.layers[layer?layer:scene.defLayer]&&scene.layers[layer?layer:scene.defLayer].noCam)}
function mousePos(layer){return isCamLayer(layer)?curScene().camMousePos:app.mousePos()}function drawSprite(id,conf){conf=void 0===conf?{}:conf;var JSCompiler_inline_result="string"===typeof id?assets.sprites[id]:id;if(!JSCompiler_inline_result)throw Error('sprite not found: "'+id+'"');gfx.drawTexture(JSCompiler_inline_result.tex,Object.assign({},conf,{quad:JSCompiler_inline_result.frames[conf.frame?conf.frame:0]}))}function scene(name,cb){game.scenes[name]={init:cb,initialized:!1,events:{add:[],
update:[],draw:[],destroy:[],keyDown:[],keyPress:[],keyPressRep:[],keyRelease:[],mouseClick:[],mouseRelease:[],mouseDown:[],charInput:[]},action:[],render:[],objs:new Map,lastObjID:0,timers:{},lastTimerID:0,cam:{pos:vec2(gfx.width()/2,gfx.height()/2),scale:vec2(1,1),angle:0,shake:0},camMousePos:vec2(0),camMatrix:mat4(),layers:{},defLayer:null,gravity:980,data:{},travelers:[],visitors:{}}}function curScene(){return game.scenes[game.curScene]}function regDebugInputs(){keyPress("`",function(){debug.showLog=
!debug.showLog;logger.info("show log: "+(debug.showLog?"on":"off"))});keyPress("f1",function(){debug.inspect=!debug.inspect;logger.info("inspect: "+(debug.inspect?"on":"off"))});keyPress("f2",function(){debug.clearLog()});keyPress("f8",function(){debug.paused=!debug.paused;logger.info(debug.paused?"paused":"unpaused")});keyPress("f7",function(){debug.timeScale=clamp(debug.timeScale-.2,0,2);logger.info("time scale: "+debug.timeScale.toFixed(1))});keyPress("f9",function(){debug.timeScale=clamp(debug.timeScale+
.2,0,2);logger.info("time scale: "+debug.timeScale.toFixed(1))});keyPress("f10",function(){debug.stepFrame();logger.info("stepped frame")})}function switchScene(name,args){for(var $jscomp$restParams=[],$jscomp$restIndex=1;$jscomp$restIndex<arguments.length;++$jscomp$restIndex)$jscomp$restParams[$jscomp$restIndex-1]=arguments[$jscomp$restIndex];if(!game.scenes[name])throw Error("scene not found: '"+name+"'");scene(name,game.scenes[name].init);game.curScene=name;$jscomp$restIndex=game.scenes[name];
if(!$jscomp$restIndex)throw Error("scene not found: '"+name+"'");if(!$jscomp$restIndex.initialized){try{$jscomp$restIndex.init.apply($jscomp$restIndex,$jscomp.arrayFromIterable($jscomp$restParams))}catch(e){logger.error(e.stack)}gconf.debug&&regDebugInputs();$jscomp$restIndex.initialized=!0}}function defComp(id,require,builder){var comp=function(args){for(var $jscomp$restParams=[],$jscomp$restIndex=0;$jscomp$restIndex<arguments.length;++$jscomp$restIndex)$jscomp$restParams[$jscomp$restIndex-0]=arguments[$jscomp$restIndex];
return Object.assign({},builder.apply(null,$jscomp.arrayFromIterable($jscomp$restParams)),{id:id,require:require})};return game.compReg[id]=comp}function add(comps){var compStates={},customState={},obj={hidden:!1,paused:!1,_tags:[],_id:null,_client:null,_events:{add:[],update:[],draw:[],destroy:[],inspect:[]},use:function(comp){if(void 0!==comp){var ty=typeof comp;if("string"===ty)this._tags.push(comp);else{if("object"!==ty)throw Error("invalid comp type: "+ty);var stateContainer=customState;comp.id&&
(compStates[comp.id]={},stateContainer=compStates[comp.id]);ty={};for(var k in comp){ty.$jscomp$loop$prop$k$70=k;a:if("id"!==ty.$jscomp$loop$prop$k$70){if("function"===typeof comp[ty.$jscomp$loop$prop$k$70])if(this._events[ty.$jscomp$loop$prop$k$70]){this._events[ty.$jscomp$loop$prop$k$70].push(comp[ty.$jscomp$loop$prop$k$70].bind(this));break a}else stateContainer[ty.$jscomp$loop$prop$k$70]=comp[ty.$jscomp$loop$prop$k$70].bind(this);else stateContainer[ty.$jscomp$loop$prop$k$70]=comp[ty.$jscomp$loop$prop$k$70];
"require"!==ty.$jscomp$loop$prop$k$70&&Object.defineProperty(this,ty.$jscomp$loop$prop$k$70,{get:function($jscomp$loop$68){return function(){return stateContainer[$jscomp$loop$68.$jscomp$loop$prop$k$70]}}(ty),set:function($jscomp$loop$68){return function(val){stateContainer[$jscomp$loop$68.$jscomp$loop$prop$k$70]=val}}(ty)})}ty={$jscomp$loop$prop$k$70:ty.$jscomp$loop$prop$k$70}}}}},c:function(id){return compStates[id]},exists:function(){return void 0!==this._id},is:function(tag){if("*"===tag)return!0;
if(Array.isArray(tag)){tag=$jscomp.makeIterator(tag);for(var $jscomp$key$t=tag.next();!$jscomp$key$t.done;$jscomp$key$t=tag.next())if(!this._tags.includes($jscomp$key$t.value))return!1;return!0}return this._tags.includes(tag)},on:function(event,cb){this._events[event]||(this._events[event]=[]);this._events[event].push(cb)},action:function(cb){this.on("update",cb)},trigger:function(event,args){for(var $jscomp$restParams=[],$jscomp$restIndex=1;$jscomp$restIndex<arguments.length;++$jscomp$restIndex)$jscomp$restParams[$jscomp$restIndex-
1]=arguments[$jscomp$restIndex];if(this._events[event]){$jscomp$restIndex=$jscomp.makeIterator(this._events[event]);for(var $jscomp$key$f=$jscomp$restIndex.next();!$jscomp$key$f.done;$jscomp$key$f=$jscomp$restIndex.next())$jscomp$key$f=$jscomp$key$f.value,$jscomp$key$f.call.apply($jscomp$key$f,[this].concat($jscomp.arrayFromIterable($jscomp$restParams)))}if($jscomp$restIndex=curScene().events[event])for($jscomp$restIndex=$jscomp.makeIterator($jscomp$restIndex),$jscomp$key$f=$jscomp$restIndex.next();!$jscomp$key$f.done;$jscomp$key$f=
$jscomp$restIndex.next())$jscomp$key$f=$jscomp$key$f.value,this.is($jscomp$key$f.tag)&&$jscomp$key$f.cb.apply($jscomp$key$f,[this].concat($jscomp.arrayFromIterable($jscomp$restParams)))},rmTag:function(t){t=this._tags.indexOf(t);-1<t&&this._tags.splice(t,1)},_data:function(){return{hidden:this.hidden,paused:this.paused,tags:this._tags,id:this._id,comps:compStates,custom:customState}}};comps=$jscomp.makeIterator(comps);for(var $jscomp$key$comp=comps.next();!$jscomp$key$comp.done;$jscomp$key$comp=comps.next())obj.use($jscomp$key$comp.value);
comps=curScene();$jscomp$key$comp=comps.lastObjID++;comps.objs.set($jscomp$key$comp,obj);obj._id=$jscomp$key$comp;obj.trigger("add");for(var id$47 in compStates)for(comps=$jscomp.makeIterator(compStates[id$47].require||[]),$jscomp$key$comp=comps.next();!$jscomp$key$comp.done;$jscomp$key$comp=comps.next())if($jscomp$key$comp=$jscomp$key$comp.value,!obj.c($jscomp$key$comp))throw Error("comp '"+id$47+"' requires comp '"+$jscomp$key$comp+"'");return obj}function on(event,tag,cb){var scene=curScene();
scene.events[event]||(scene.events[event]=[]);scene.events[event].push({tag:tag,cb:cb})}function action(tag,cb){"function"===typeof tag&&void 0===cb?curScene().action.push(tag):"string"===typeof tag&&on("update",tag,cb)}function wait(t,f){return new Promise(function(resolve){var scene=curScene();scene.timers[scene.lastTimerID++]={time:t,cb:function(){f&&f();resolve()}}})}function pushKeyEvent(e,k,f){if(Array.isArray(k)){k=$jscomp.makeIterator(k);for(var $jscomp$key$key=k.next();!$jscomp$key$key.done;$jscomp$key$key=
k.next())pushKeyEvent(e,$jscomp$key$key.value,f)}else curScene().events[e].push({key:k,cb:f})}function keyPress(k,f){pushKeyEvent("keyPress",k,f)}function get(t){var scene=curScene(),objs=[].concat($jscomp.arrayFromIterable(scene.objs.values())).sort(function(o1,o2){return(scene.layers[o1.layer?o1.layer:scene.defLayer]&&scene.layers[o1.layer?o1.layer:scene.defLayer].order||0)-(scene.layers[o2.layer?o2.layer:scene.defLayer]&&scene.layers[o2.layer?o2.layer:scene.defLayer].order||0)});return t?objs.filter(function(obj){return obj.is(t)}):
objs}function every(t,f){if("function"===typeof t&&void 0===f)return get().map(t);if("string"===typeof t)return get(t).map(f)}function revery(t,f){if("function"===typeof t&&void 0===f)return get().reverse().map(t);if("string"===typeof t)return get(t).reverse().map(f)}function destroy(obj){if(obj.exists()){var scene=curScene();scene&&(obj.trigger("destroy"),scene.objs.delete(obj._id),delete obj._id)}}function gravity(g){var scene=curScene();void 0!==g&&(scene.gravity=g);return scene.gravity}function gameFrame(ignorePause){var scene=
curScene();if(!scene)throw Error("scene not found: '"+game.curScene+"'");var doUpdate=ignorePause||!debug.paused;if(doUpdate)for(var id in scene.timers)ignorePause=scene.timers[id],ignorePause.time-=dt(),0>=ignorePause.time&&(ignorePause.cb(),delete scene.timers[id]);revery(function(obj){!obj.paused&&doUpdate&&obj.trigger("update")});if(doUpdate)for(id=$jscomp.makeIterator(scene.action),ignorePause=id.next();!ignorePause.done;ignorePause=id.next())ignorePause=ignorePause.value,ignorePause();id=vec2(gfx.width(),
gfx.height());ignorePause=scene.cam;var shake=vec2FromAngle(rand(0,2*Math.PI)).scale(ignorePause.shake);ignorePause.shake=lerp(ignorePause.shake,0,5*dt());scene.camMatrix=mat4().translate(id.scale(.5)).scale(ignorePause.scale).rotateZ(ignorePause.angle).translate(id.scale(-.5)).translate(ignorePause.pos.scale(-1).add(id.scale(.5)).add(shake));scene.camMousePos=scene.camMatrix.invert().multVec2(app.mousePos());every(function(obj){obj.hidden||(gfx.pushTransform(),isCamLayer(obj.layer)&&gfx.pushMatrix(scene.camMatrix),
obj.trigger("draw"),gfx.popTransform())});id=$jscomp.makeIterator(scene.render);for(ignorePause=id.next();!ignorePause.done;ignorePause=id.next())ignorePause=ignorePause.value,ignorePause()}function drawInspect(){function drawInspectTxt(pos,txt,scale){var pad=vec2(4).scale(1/scale);txt=gfx.fmtText(txt,font,{size:12/scale,pos:pos.add(vec2(pad.x,pad.y))});gfx.drawRect(pos,txt.width+2*pad.x,txt.height+2*pad.x,{color:rgba(0,0,0,1)});gfx.drawFmtText(txt)}function drawObj(obj,f){obj=isCamLayer(obj.layer);
var scale=gfx.scale()*(obj?(scene.cam.scale.x+scene.cam.scale.y)/2:1);obj&&(gfx.pushTransform(),gfx.pushMatrix(scene.camMatrix));f(scale);obj&&gfx.popTransform()}var scene=curScene(),inspecting=null,font=assets.defFont(),lcolor=rgba(gconf.inspectColor?gconf.inspectColor:[0,1,1,1]);revery(function(obj){obj.area&&(obj.hidden||drawObj(obj,function(scale){inspecting||obj.isHovered()&&(inspecting=obj);scale=(inspecting===obj?6:2)/scale;var a=obj._worldArea();gfx.drawRectStroke(a.p1,a.p2.x-a.p1.x,a.p2.y-
a.p1.y,{width:scale,color:lcolor})}))});inspecting&&drawObj(inspecting,function(scale){for(var mpos=mousePos(inspecting.layer),lines=[],$jscomp$iter$23=$jscomp.makeIterator(inspecting._tags),$jscomp$key$tag=$jscomp$iter$23.next();!$jscomp$key$tag.done;$jscomp$key$tag=$jscomp$iter$23.next())lines.push('"'+$jscomp$key$tag.value+'"');$jscomp$iter$23=$jscomp.makeIterator(inspecting._events.inspect);for($jscomp$key$tag=$jscomp$iter$23.next();!$jscomp$key$tag.done;$jscomp$key$tag=$jscomp$iter$23.next()){$jscomp$key$tag=
$jscomp$key$tag.value;$jscomp$key$tag=$jscomp$key$tag();for(var field in $jscomp$key$tag)lines.push(field+": "+$jscomp$key$tag[field])}drawInspectTxt(mpos,lines.join("\n"),scale)});drawInspectTxt(vec2(0),app.fps()+"",gfx.scale())}function isSameLayer(o1,o2){var scene=curScene();return(o1.layer?o1.layer:scene.defLayer)===(o2.layer?o2.layer:scene.defLayer)}function getAreaFromSize(w,h,o){w=vec2(w,h);o=originPt(o||"topleft").scale(w).scale(-.5);return area(o.sub(w.scale(.5)),o.add(w.scale(.5)))}gconf=
void 0===gconf?{width:640,height:480,scale:1,fullscreen:!1,debug:!1,crisp:!1,canvas:null,connect:null,logMax:8,root:document.body}:gconf;var app=appInit({width:gconf.width,height:gconf.height,scale:gconf.scale,fullscreen:gconf.fullscreen,crisp:gconf.crisp,canvas:gconf.canvas,root:gconf.root}),gfx=gfxInit(app.gl,{clearColor:gconf.clearColor?rgba(gconf.clearColor):void 0,scale:gconf.scale,texFilter:gconf.texFilter}),audio=audioInit(),assets=assetsInit(gfx,audio,{errHandler:function(err){logger.error(err)}}),
logger=loggerInit(gfx,assets,{max:gconf.logMax}),net=gconf.connect?netInit(gconf.connect):null;net&&(recv("ADD_OBJ",function(id,data){data=curScene();data.visitors[id]||(data.visitors[id]={})}),recv("DESTROY_OBJ",function(id,data){var scene=curScene();if(scene.visitors[id]){var oid=scene.visitors[id][data.id];null!=oid&&(destroy(scene.objs.get(oid)),delete scene.visitors[id][data.id])}}),recv("DISCONNECT",function(id,data){data=curScene();if(data.visitors[id]){for(var $jscomp$iter$6=$jscomp.makeIterator(Object.values(data.visitors[id])),
$jscomp$key$oid=$jscomp$iter$6.next();!$jscomp$key$oid.done;$jscomp$key$oid=$jscomp$iter$6.next())destroy(data.objs.get($jscomp$key$oid.value));delete data.visitors[id]}}));var game={loaded:!1,scenes:{},curScene:null,nextScene:null,compReg:{}},pos$jscomp$0=defComp("pos",[],function(args$jscomp$0){for(var $jscomp$restParams$jscomp$0=[],$jscomp$restIndex$jscomp$0=0;$jscomp$restIndex$jscomp$0<arguments.length;++$jscomp$restIndex$jscomp$0)$jscomp$restParams$jscomp$0[$jscomp$restIndex$jscomp$0-0]=arguments[$jscomp$restIndex$jscomp$0];
return{pos:vec2.apply(null,$jscomp.arrayFromIterable($jscomp$restParams$jscomp$0)),move:function(args){for(var $jscomp$restParams=[],$jscomp$restIndex=0;$jscomp$restIndex<arguments.length;++$jscomp$restIndex)$jscomp$restParams[$jscomp$restIndex-0]=arguments[$jscomp$restIndex];$jscomp$restIndex=vec2.apply(null,$jscomp.arrayFromIterable($jscomp$restParams));$jscomp$restParams=$jscomp$restIndex.x*dt();$jscomp$restIndex=$jscomp$restIndex.y*dt();this.pos.x+=$jscomp$restParams;this.pos.y+=$jscomp$restIndex},
screenPos:function(){return curScene().camMatrix.multVec2(this.pos)},inspect:function(){return{pos:"("+~~this.pos.x+", "+~~this.pos.y+")"}}}}),scale$jscomp$0=defComp("scale",[],function(args){for(var $jscomp$restParams=[],$jscomp$restIndex=0;$jscomp$restIndex<arguments.length;++$jscomp$restIndex)$jscomp$restParams[$jscomp$restIndex-0]=arguments[$jscomp$restIndex];return 0===$jscomp$restParams.length?scale$jscomp$0(1):{scale:vec2.apply(null,$jscomp.arrayFromIterable($jscomp$restParams)),flipX:function(s){this.scale.x=
Math.sign(s)*Math.abs(this.scale.x)},flipY:function(s){this.scale.y=Math.sign(s)*Math.abs(this.scale.y)}}}),rotate=defComp("rotate",[],function(r){return{angle:r?r:0}}),color=defComp("color",[],function(args){for(var $jscomp$restParams=[],$jscomp$restIndex=0;$jscomp$restIndex<arguments.length;++$jscomp$restIndex)$jscomp$restParams[$jscomp$restIndex-0]=arguments[$jscomp$restIndex];return{color:rgba.apply(null,$jscomp.arrayFromIterable($jscomp$restParams))}}),origin$jscomp$0=defComp("origin",[],function(origin){return{origin:origin}}),
layer$jscomp$0=defComp("layer",[],function(layer){return{layer:layer,inspect:function(){var scene=curScene();return{layer:this.layer?this.layer:scene.defLayer}}}}),area=defComp("area",[],function(p1$jscomp$0,p2){var colliding={},overlapping={};return{area:{p1:p1$jscomp$0,p2:p2},areaWidth:function(){var $jscomp$destructuring$var4=this._worldArea();return $jscomp$destructuring$var4.p2.x-$jscomp$destructuring$var4.p1.x},areaHeight:function(){var $jscomp$destructuring$var5=this._worldArea();return $jscomp$destructuring$var5.p2.y-
$jscomp$destructuring$var5.p1.y},isClicked:function(){return app.mouseClicked()&&this.isHovered()},isHovered:function(){return this.hasPt(mousePos(this.layer))},isCollided:function(other){if(!other.area||!isSameLayer(this,other))return!1;var a1=this._worldArea();other=other._worldArea();return colRectRect(a1,other)},isOverlapped:function(other){if(!other.area||!isSameLayer(this,other))return!1;var a1=this._worldArea();other=other._worldArea();return a1.p2.x>other.p1.x&&a1.p1.x<other.p2.x&&a1.p2.y>
other.p1.y&&a1.p1.y<other.p2.y},clicks:function(f){var $jscomp$this=this;this.action(function(){$jscomp$this.isClicked()&&f()})},hovers:function(f){var $jscomp$this=this;this.action(function(){$jscomp$this.isHovered()&&f()})},collides:function(tag,f){var $jscomp$this=this;this.action(function(){$jscomp$this._checkCollisions(tag,f)})},overlaps:function(tag,f){var $jscomp$this=this;this.action(function(){$jscomp$this._checkOverlaps(tag,f)})},hasPt:function(pt){var a=this._worldArea(),JSCompiler_object_inline_p1_116=
a.p1;a=a.p2;return pt.x>=JSCompiler_object_inline_p1_116.x&&pt.x<=a.x&&pt.y>=JSCompiler_object_inline_p1_116.y&&pt.y<a.y},pushOut:function(obj){if(obj===this||!obj.area||!isSameLayer(this,obj))return null;var a1=this._worldArea(),a2=obj._worldArea();if(!colRectRect(a1,a2))return null;var disLeft=a1.p2.x-a2.p1.x,disRight=a2.p2.x-a1.p1.x,disTop=a1.p2.y-a2.p1.y;a1=a2.p2.y-a1.p1.y;switch(Math.min(disLeft,disRight,disTop,a1)){case disLeft:return this.pos.x-=disLeft,{obj:obj,side:"right",dis:-disLeft};
case disRight:return this.pos.x+=disRight,{obj:obj,side:"left",dis:disRight};case disTop:return this.pos.y-=disTop,{obj:obj,side:"bottom",dis:-disTop};case a1:return this.pos.y+=a1,{obj:obj,side:"top",dis:a1}}return null},pushOutAll:function(){var $jscomp$this=this;return every(function(other){return other.solid?$jscomp$this.pushOut(other):null}).filter(function(res){return null!=res})},_checkCollisions:function(tag,f){var $jscomp$this=this;every(tag,function(obj){$jscomp$this!==obj&&!colliding[obj._id]&&
$jscomp$this.isCollided(obj)&&(f(obj),colliding[obj._id]=obj)});for(var id in colliding)this.isCollided(colliding[id])||delete colliding[id]},_checkOverlaps:function(tag,f){var $jscomp$this=this;every(tag,function(obj){$jscomp$this!==obj&&!overlapping[obj._id]&&$jscomp$this.isOverlapped(obj)&&(f(obj),overlapping[obj._id]=obj)});for(var id in overlapping)this.isOverlapped(overlapping[id])||delete overlapping[id]},_worldArea:function(){var a=this.area,pos=this.pos||vec2(0),scale=this.scale||vec2(1),
p1=pos.add(a.p1.scale(scale));a=pos.add(a.p2.scale(scale));return{p1:vec2(Math.min(p1.x,a.x),Math.min(p1.y,a.y)),p2:vec2(Math.max(p1.x,a.x),Math.max(p1.y,a.y))}}}}),sprite=defComp("sprite",[],function(id$jscomp$0,conf){conf=void 0===conf?{}:conf;var spr=assets.sprites[id$jscomp$0];if(!spr)throw Error('sprite not found: "'+id$jscomp$0+'"');id$jscomp$0=Object.assign({},spr.frames[0]);conf.quad&&(id$jscomp$0.x+=conf.quad.x*id$jscomp$0.w,id$jscomp$0.y+=conf.quad.y*id$jscomp$0.h,id$jscomp$0.w*=conf.quad.w,
id$jscomp$0.h*=conf.quad.h);var curAnim=null;return{width:spr.tex.width*id$jscomp$0.w,height:spr.tex.height*id$jscomp$0.h,animSpeed:conf.animSpeed||.1,frame:conf.frame||0,quad:conf.quad||quad(0,0,1,1),add:function(){this.area||conf.noArea||this.use(getAreaFromSize(this.width,this.height,this.origin))},draw:function(){curScene();drawSprite(spr,{pos:this.pos,scale:this.scale,rot:this.angle,color:this.color,frame:this.frame,origin:this.origin,quad:this.quad,prog:assets.shaders[this.shader],uniform:this.uniform})},
update:function(){if(curAnim){var anim=spr.anims[curAnim.name];curAnim.timer+=dt();curAnim.timer>=this.animSpeed&&(this.frame++,this.frame>anim.to&&(curAnim.loop?this.frame=anim.from:(this.frame--,this.stop())),curAnim&&(curAnim.timer-=this.animSpeed))}},play:function(name,loop){loop=void 0===loop?!0:loop;var anim=spr.anims[name];if(!anim)throw Error("anim not found: "+name);curAnim&&this.stop();curAnim={name:name,loop:loop,timer:0};this.frame=anim.from;this.trigger("animPlay",name)},stop:function(){if(curAnim){var prevAnim=
curAnim.name;curAnim=null;this.trigger("animEnd",prevAnim)}},changeSprite:function(id){spr=assets.sprites[id];if(!spr)throw Error('sprite not found: "'+id+'"');id=Object.assign({},spr.frames[0]);conf.quad&&(id.x+=conf.quad.x*id.w,id.y+=conf.quad.y*id.h,id.w*=conf.quad.w,id.h*=conf.quad.h);this.width=spr.tex.width*id.w;this.height=spr.tex.height*id.h;this.area&&!conf.noArea&&this.use(getAreaFromSize(this.width,this.height,this.origin));curAnim=null;this.frame=0},numFrames:function(){return spr.frames.length},
curAnim:function(){return curAnim&&curAnim.name},inspect:function(){var info={};curAnim&&(info.curAnim='"'+curAnim.name+'"');return info}}}),text=defComp("text",[],function(t,size,conf){conf=void 0===conf?{}:conf;return{text:t,textSize:size,font:conf.font,width:0,height:0,add:function(){if(!this.area&&!conf.noArea){curScene();var ftext=gfx.fmtText(this.text+"",assets.fonts[this.font?this.font:"unscii"],{pos:this.pos,scale:this.scale,rot:this.angle,size:this.textSize,origin:this.origin,color:this.color,
width:conf.width});this.width=ftext.width/(this.scale&&this.scale.x||1);this.height=ftext.height/(this.scale&&this.scale.y||1);this.use(getAreaFromSize(this.width,this.height,this.origin))}},draw:function(){curScene();var ftext=gfx.fmtText(this.text+"",assets.fonts[this.font?this.font:"unscii"],{pos:this.pos,scale:this.scale,rot:this.angle,size:this.textSize,origin:this.origin,color:this.color,width:conf.width});this.width=ftext.width;this.height=ftext.height;gfx.drawFmtText(ftext)}}}),rect=defComp("rect",
[],function(w,h,conf){conf=void 0===conf?{}:conf;return{width:w,height:h,add:function(){this.area||conf.noArea||this.use(getAreaFromSize(this.width,this.height,this.origin))},draw:function(){curScene();gfx.drawRect(this.pos,this.width,this.height,{scale:this.scale,rot:this.angle,color:this.color,origin:this.origin,prog:assets.shaders[this.shader],uniform:this.uniform})}}}),solid=defComp("solid",[],function(){return{solid:!0}}),body=defComp("body",["pos","area"],function(conf){conf=void 0===conf?{}:
conf;var velY=0,curPlatform=null,lastPlatformPos=null,maxVel=conf.maxVel?conf.maxVel:960;return{jumpForce:conf.jumpForce?conf.jumpForce:480,update:function(){this.move(0,velY);var targets=this.pushOutAll(),justOff=!1;curPlatform&&(curPlatform.exists()&&this.isCollided(curPlatform)?lastPlatformPos&&(this.pos=this.pos.add(curPlatform.pos.sub(lastPlatformPos)),lastPlatformPos=curPlatform.pos.clone()):(lastPlatformPos=curPlatform=null,justOff=!0));if(!curPlatform){velY=Math.min(velY+gravity()*dt(),maxVel);
targets=$jscomp.makeIterator(targets);for(var $jscomp$key$target=targets.next();!$jscomp$key$target.done;$jscomp$key$target=targets.next())$jscomp$key$target=$jscomp$key$target.value,"bottom"===$jscomp$key$target.side&&0<velY?(curPlatform=$jscomp$key$target.obj,velY=0,lastPlatformPos=curPlatform.pos.clone(),justOff||this.trigger("grounded",curPlatform)):"top"===$jscomp$key$target.side&&0>velY&&(velY=0,this.trigger("headbutt",$jscomp$key$target.obj))}},curPlatform:function(){return curPlatform},grounded:function(){return null!==
curPlatform},falling:function(){return 0<velY},jump:function(force){curPlatform=null;velY=-force||-this.jumpForce}}}),shader=defComp("shader",[],function(id,uniform){uniform=void 0===uniform?{}:uniform;return{shader:id,uniform:uniform}}),debug={paused:!1,inspect:!1,timeScale:1,showLog:!0,fps:app.fps,objCount:function(){return curScene().objs.size},stepFrame:function(){gameFrame(!0)},drawCalls:gfx.drawCalls,clearLog:logger.clear,log:logger.info,error:logger.error},gridder=defComp("gridder",[],function(level,
pos){return{gridPos:pos.clone(),setGridPos:function(p){this.gridPos=p.clone();this.pos=vec2(level.offset().x+this.gridPos.x*level.gridWidth(),level.offset().y+this.gridPos.y*level.gridHeight())},moveLeft:function(){this.setGridPos(this.gridPos.add(vec2(-1,0)))},moveRight:function(){this.setGridPos(this.gridPos.add(vec2(1,0)))},moveUp:function(){this.setGridPos(this.gridPos.add(vec2(0,-1)))},moveDown:function(){this.setGridPos(this.gridPos.add(vec2(0,1)))}}});rotate={start:function(name,args){for(var $jscomp$restParams=
[],$jscomp$restIndex=1;$jscomp$restIndex<arguments.length;++$jscomp$restIndex)$jscomp$restParams[$jscomp$restIndex-1]=arguments[$jscomp$restIndex];app.run(function(){gfx.frameStart();if(game.loaded){try{if(!curScene())throw Error("scene not found: '"+game.curScene+"'");for(var scene=curScene(),$jscomp$inline_90=$jscomp.makeIterator(scene.events.charInput),$jscomp$inline_91=$jscomp$inline_90.next();!$jscomp$inline_91.done;$jscomp$inline_91=$jscomp$inline_90.next()){var e$jscomp$0=$jscomp$inline_91.value;
app.charInputted().forEach(e$jscomp$0.cb)}var $jscomp$inline_93=$jscomp.makeIterator(scene.events.keyDown);for($jscomp$inline_91=$jscomp$inline_93.next();!$jscomp$inline_91.done;$jscomp$inline_91=$jscomp$inline_93.next()){var e$51=$jscomp$inline_91.value;app.keyDown(e$51.key)&&e$51.cb()}var $jscomp$inline_95=$jscomp.makeIterator(scene.events.keyPress);for($jscomp$inline_91=$jscomp$inline_95.next();!$jscomp$inline_91.done;$jscomp$inline_91=$jscomp$inline_95.next()){var e$52=$jscomp$inline_91.value;
app.keyPressed(e$52.key)&&e$52.cb()}var $jscomp$inline_97=$jscomp.makeIterator(scene.events.keyPressRep);for($jscomp$inline_91=$jscomp$inline_97.next();!$jscomp$inline_91.done;$jscomp$inline_91=$jscomp$inline_97.next()){var e$53=$jscomp$inline_91.value;app.keyPressedRep(e$53.key)&&e$53.cb()}var $jscomp$inline_99=$jscomp.makeIterator(scene.events.keyRelease);for($jscomp$inline_91=$jscomp$inline_99.next();!$jscomp$inline_91.done;$jscomp$inline_91=$jscomp$inline_99.next()){var e$54=$jscomp$inline_91.value;
app.keyReleased(e$54.key)&&e$54.cb()}var $jscomp$inline_101=$jscomp.makeIterator(scene.events.mouseDown);for($jscomp$inline_91=$jscomp$inline_101.next();!$jscomp$inline_91.done;$jscomp$inline_91=$jscomp$inline_101.next()){var e$55=$jscomp$inline_91.value;app.mouseDown()&&e$55.cb()}var $jscomp$inline_103=$jscomp.makeIterator(scene.events.mouseClick);for($jscomp$inline_91=$jscomp$inline_103.next();!$jscomp$inline_91.done;$jscomp$inline_91=$jscomp$inline_103.next()){var e$56=$jscomp$inline_91.value;
app.mouseClicked()&&e$56.cb()}var $jscomp$inline_105=$jscomp.makeIterator(scene.events.mouseRelease);for($jscomp$inline_91=$jscomp$inline_105.next();!$jscomp$inline_91.done;$jscomp$inline_91=$jscomp$inline_105.next()){var e$57=$jscomp$inline_91.value;app.mouseReleased()&&e$57.cb()}gameFrame();debug.inspect&&drawInspect()}catch(e){logger.error(e.stack),app.quit()}debug.showLog&&logger.draw();game.nextScene&&(switchScene.apply(null,[game.nextScene.name].concat($jscomp.arrayFromIterable(game.nextScene.args))),
game.nextScene=null)}else scene=assets.loadProgress(),1===scene?(game.loaded=!0,switchScene.apply(null,[name].concat($jscomp.arrayFromIterable($jscomp$restParams))),net&&net.connect().catch(logger.error)):($jscomp$inline_90=gfx.width()/2,$jscomp$inline_91=24/gfx.scale(),e$jscomp$0=vec2(gfx.width()/2,gfx.height()/2).sub(vec2($jscomp$inline_90/2,$jscomp$inline_91/2)),gfx.drawRect(vec2(0),gfx.width(),gfx.height(),{color:rgb(0,0,0)}),gfx.drawRectStroke(e$jscomp$0,$jscomp$inline_90,$jscomp$inline_91,{width:4/
gfx.scale()}),gfx.drawRect(e$jscomp$0,$jscomp$inline_90*scene,$jscomp$inline_91));gfx.frameEnd()})},loadRoot:assets.loadRoot,loadSprite:assets.loadSprite,loadSound:assets.loadSound,loadFont:assets.loadFont,loadShader:assets.loadShader,addLoader:assets.addLoader,width:gfx.width,height:gfx.height,dt:dt,time:app.time,screenshot:app.screenshot,focused:app.focused,focus:app.focus,scene:scene,go:function(name,args){for(var $jscomp$restParams=[],$jscomp$restIndex=1;$jscomp$restIndex<arguments.length;++$jscomp$restIndex)$jscomp$restParams[$jscomp$restIndex-
1]=arguments[$jscomp$restIndex];game.nextScene={name:name,args:[].concat($jscomp.arrayFromIterable($jscomp$restParams))}},sceneData:function(){return curScene().data},layers:function(list,def){var scene=curScene();scene&&(list.forEach(function(name,idx){scene.layers[name]={alpha:1,order:idx+1,noCam:!1}}),def&&(scene.defLayer=def))},camPos:function(pos){for(var $jscomp$restParams=[],$jscomp$restIndex=0;$jscomp$restIndex<arguments.length;++$jscomp$restIndex)$jscomp$restParams[$jscomp$restIndex-0]=arguments[$jscomp$restIndex];
$jscomp$restIndex=curScene().cam;0<$jscomp$restParams.length&&($jscomp$restIndex.pos=vec2.apply(null,$jscomp.arrayFromIterable($jscomp$restParams)));return $jscomp$restIndex.pos.clone()},camScale:function(scale){for(var $jscomp$restParams=[],$jscomp$restIndex=0;$jscomp$restIndex<arguments.length;++$jscomp$restIndex)$jscomp$restParams[$jscomp$restIndex-0]=arguments[$jscomp$restIndex];$jscomp$restIndex=curScene().cam;0<$jscomp$restParams.length&&($jscomp$restIndex.scale=vec2.apply(null,$jscomp.arrayFromIterable($jscomp$restParams)));
return $jscomp$restIndex.scale.clone()},camRot:function(angle){var cam=curScene().cam;void 0!==angle&&(cam.angle=angle);return cam.angle},camShake:function(intensity){curScene().cam.shake=intensity},camIgnore:function(layers){var scene=curScene();layers.forEach(function(name){scene.layers[name]&&(scene.layers[name].noCam=!0)})},gravity:gravity,add:add,readd:function(obj){if(obj.exists()){var scene=curScene();scene.objs.delete(obj._id);var id=scene.lastObjID++;scene.objs.set(id,obj);obj._id=id;return obj}},
destroy:destroy,destroyAll:function(t){every(t,function(obj){destroy(obj)})},get:get,every:every,revery:revery,defComp:defComp,sync:function(obj){if(!net)throw Error("not connected to any websockets");curScene().travelers.push(obj._id);send("ADD_OBJ",obj._data())},send:send,recv:recv,pos:pos$jscomp$0,scale:scale$jscomp$0,rotate:rotate,color:color,origin:origin$jscomp$0,layer:layer$jscomp$0,area:area,sprite:sprite,text:text,rect:rect,solid:solid,body:body,shader:shader,on:on,action:action,render:function(tag,
cb){"function"===typeof tag&&void 0===cb?curScene().render.push(tag):"string"===typeof tag&&on("update",tag,cb)},collides:function(t1,t2,f){action(t1,function(o1){o1._checkCollisions(t2,function(o2){f(o1,o2)})})},overlaps:function(t1,t2,f){action(t1,function(o1){o1._checkOverlaps(t2,function(o2){f(o1,o2)})})},clicks:function(t,f){action(t,function(o){o.isClicked()&&f(o)})},keyDown:function(k,f){pushKeyEvent("keyDown",k,f)},keyPress:keyPress,keyPressRep:function(k,f){pushKeyEvent("keyPressRep",k,f)},
keyRelease:function(k,f){pushKeyEvent("keyRelease",k,f)},charInput:function(f){curScene().events.charInput.push({cb:f})},mouseDown:function(f){curScene().events.mouseDown.push({cb:f})},mouseClick:function(f){curScene().events.mouseClick.push({cb:f})},mouseRelease:function(f){curScene().events.mouseRelease.push({cb:f})},mousePos:mousePos,cursor:app.cursor,keyIsDown:app.keyDown,keyIsPressed:app.keyPressed,keyIsPressedRep:app.keyPressedRep,keyIsReleased:app.keyReleased,mouseIsDown:app.mouseDown,mouseIsClicked:app.mouseClicked,
mouseIsReleased:app.mouseReleased,loop:function(t,f){var stopped=!1,newF=function(){stopped||(f(),wait(t,newF))};newF();return{stop:function(){stopped=!0}}},wait:wait,play:function(id,conf){conf=void 0===conf?{}:conf;var sound=assets.sounds[id];if(!sound)throw Error('sound not found: "'+id+'"');return audio.play(sound,conf)},volume:audio.volume,makeRng:makeRng,rand:rand,randSeed:randSeed,vec2:vec2,rgb:rgb,rgba:rgba,quad:quad,choose:choose,chance:chance,lerp:lerp,map:map,mapc:mapc,wave:wave,deg2rad:deg2rad,
rad2deg:rad2deg,drawSprite:drawSprite,drawText:function(txt,conf){conf=void 0===conf?{}:conf;var fid=conf.font?conf.font:"unscii",font=assets.fonts[fid];if(!font)throw Error("font not found: "+fid);gfx.drawText(txt,font,conf)},drawRect:gfx.drawRect,drawRectStroke:gfx.drawRectStroke,drawLine:gfx.drawLine,debug:debug,addLevel:function(map,conf){var pool=[],offset=vec2(conf.pos||0),longRow=0,level={offset:function(){return offset.clone()},gridWidth:function(){return conf.width},gridHeight:function(){return conf.height},
getPos:function(args){for(var $jscomp$restParams=[],$jscomp$restIndex=0;$jscomp$restIndex<arguments.length;++$jscomp$restIndex)$jscomp$restParams[$jscomp$restIndex-0]=arguments[$jscomp$restIndex];$jscomp$restParams=vec2.apply(null,$jscomp.arrayFromIterable($jscomp$restParams));return vec2(offset.x+$jscomp$restParams.x*conf.width,offset.y+$jscomp$restParams.y*conf.height)},spawn:function(sym,p){var comps=function(){if(Array.isArray(sym))return sym;if(conf[sym]){if("function"===typeof conf[sym])return conf[sym]();
if(Array.isArray(conf[sym]))return[].concat($jscomp.arrayFromIterable(conf[sym]))}else if(conf.any)return conf.any(sym)}();if(comps)return comps.push(pos$jscomp$0(offset.x+p.x*conf.width,offset.y+p.y*conf.height)),comps=add(comps),pool.push(comps),comps.use(gridder(this,p)),comps},width:function(){return longRow*conf.width},height:function(){return map.length*conf.height},destroy:function(){for(var $jscomp$iter$26=$jscomp.makeIterator(pool),$jscomp$key$obj=$jscomp$iter$26.next();!$jscomp$key$obj.done;$jscomp$key$obj=
$jscomp$iter$26.next())destroy($jscomp$key$obj.value)}};map.forEach(function(row,i){row=row.split("");longRow=Math.max(row.length,longRow);row.forEach(function(sym,j){level.spawn(sym,vec2(j,i))})});return level}};if(gconf.plugins)for(color=$jscomp.makeIterator(gconf.plugins),origin$jscomp$0=color.next();!origin$jscomp$0.done;origin$jscomp$0=color.next()){origin$jscomp$0=origin$jscomp$0.value;origin$jscomp$0=origin$jscomp$0(rotate);for(var k$jscomp$0 in origin$jscomp$0)rotate[k$jscomp$0]=origin$jscomp$0[k$jscomp$0]}if(gconf.global)for(var k$67 in rotate)window[k$67]=
rotate[k$67];return rotate}}
//# sourceMappingURL=module$reboom.js.map
